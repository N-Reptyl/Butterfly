---
title: "Nos concerts & notre répertoire"
layout: layouts/base.njk
---

<section class="bg-[url(/images/fond.png)] bg-no-repeat bg-fixed bg-cover text-white py-10">
	<div class="mt-10 max-w-6xl mx-auto px-4">
		
		<!-- Titre page -->
		<div class="flex justify-center">
			<div class="inline-flex flex-col items-center gap-2">
				<span class="h-[3px] w-full bg-white/80"></span>
				<h1 class="text-2xl md:text-3xl font-extrabold uppercase tracking-wide text-center px-4 py-1 bg-white/10 ring-1 ring-white/25">
					Nos concerts & notre répertoire
				</h1>
				<span class="h-[3px] w-full bg-white/80"></span>
			</div>
		</div>
		<p class="text-center text-white/90 mb-4">Découvrez nos concerts passés et à venir ci-dessous&nbsp;!</p>
		
		{# ===== CONCERT À VENIR (SINGULIER) ===== #}
		{% set next = null %}
		{% if collections.concertsUpcoming and (collections.concertsUpcoming | length) > 0 %}
		{% set next = collections.concertsUpcoming[0] %}
		{% endif %}
		
		{% if next %}
		<section aria-labelledby="upcoming-title" class="mb-14">
			<h2 id="upcoming-title" class="text-center text-2xl md:text-3xl font-extrabold mb-6">Concert à venir</h2>
			
			<article class="grid grid-cols-1 md:grid-cols-12 gap-8 md:gap-10 md:items-center">
				<!-- Image -->
				<figure class="md:col-span-4 relative">
					<div class="relative overflow-hidden ring-1 ring-white/20 shadow-lg bg-white/5" style="padding-top: 141.4%;">
						<img src="{{ next.data.image }}" alt="{{ next.data.title }}" class="absolute inset-0 w-full h-full object-cover">
					</div>
					<!-- Filets décoratifs gauche (option) -->
				<span class="hidden md:block absolute -left-6 top-16 h-[60%] w-px bg-white/20"></span>
				<span class="hidden md:block absolute -left-10 top-28 h-[38%] w-px bg-white/10"></span>
				</figure>
				
				
				
				<!-- Texte + coins blancs -->
				<div class="md:col-span-8 relative">
					<span class="pointer-events-none absolute -top-2 -right-2 h-[3px] w-20 bg-white"></span>
					<span class="pointer-events-none absolute -top-2 -right-2 h-20 w-[3px] bg-white"></span>
					<span class="pointer-events-none absolute -bottom-2 -left-2 h-[3px] w-20 bg-white"></span>
					<span class="pointer-events-none absolute -bottom-2 -left-2 h-20 w-[3px] bg-white"></span>
					
					<div class="bg-[#183831] ring-1 ring-white/20 px-6 py-6 md:px-7 md:py-7 shadow-lg">
						<h3 class="text-2xl md:text-3xl font-extrabold mb-1">{{ next.data.title }}</h3>
						{% if next.data.subtitle %}<p class="text-white/80 mb-4">{{ next.data.subtitle }}</p>{% endif %}
						
						{% if next.data.excerpt %}
						<p class="leading-relaxed mb-6">{{ next.data.excerpt }}</p>
						{% else %}
						<div class="leading-relaxed mb-6">
							{{ next.templateContent | safe }}
						</div>
						{% endif %}
						
						<!-- Liste des dates à venir -->
						<div class="space-y-4">
							<h4 class="font-bold text-white/90">Dates</h4>
							<ul class="space-y-3">
								{% for d in next.data.dates %}
								{# Construire les chaînes AVANT usage dans les attributs #}
								{% set loc = d.venue %}
								{% if d.city %}{% set loc = loc ~ ', ' ~ d.city %}{% endif %}
								{% set desc = next.data.subtitle or '' %}
								
								<li class="bg-white/5 ring-1 ring-white/15 rounded-lg px-4 py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
									<!-- Date + lieu -->
									<div class="flex items-start gap-3">
										<div class="flex-shrink-0 text-center ring-1 ring-white/30 rounded-md px-3 py-2 leading-tight">
											<div class="font-extrabold text-lg date-dd" data-start="{{ d.start }}"></div>
											<div class="text-[10px] uppercase tracking-wide date-mm" data-start="{{ d.start }}"></div>
										</div>
										<div>
											<div class="font-semibold date-full" data-start="{{ d.start }}" data-end="{{ d.end }}"></div>
											<div class="opacity-90">{{ loc }}</div>
											<a href="#"
											class="text-white no-underline hover:text-white/80 add-ics"
											data-title="{{ next.data.title | escape }}"
											data-description="{{ desc | escape }}"
											data-start="{{ d.start }}"
											data-end="{{ d.end }}"
											data-location="{{ loc | escape }}">
												➕ Ajouter au calendrier
											</a>
											
										</div>
									</div>
									
									<!-- Actions -->
									<div class="flex items-center gap-2">
										{% if d.tickets %}
										<a href="{{ d.tickets }}" target="_blank" rel="noopener"
										class="px-3 py-2 rounded-md font-semibold bg-[#c79b6a] hover:bg-[#d2ab7f] text-[#0B1D3B] shadow">
											Billetterie
										</a>
										{% endif %}
									</div>
								</li>
								{% endfor %}
							</ul>
						</div>
					</div>
				</div>
			</article>
		</section>
		{% endif %}
		
	</div>
		{# ===== CONCERTS PASSÉS ===== #}
		<section aria-labelledby="past-title" class="">
			<div class="relative flex items-center">
				<div class="flex-grow border-t border-white/30"></div>
				<span class="mx-4 text-white/60 uppercase tracking-wide text-sm">-</span>
				<div class="flex-grow border-t border-white/30"></div>
			</div>
			
			<h2 id="past-title" class="text-[#183831] text-center text-2xl md:text-3xl font-extrabold mb-6">Concerts passés</h2>
			<div class="bg-white grid gap-4 md:gap-1 md:grid-cols-3">
				{% for c in collections.concertsPast %}
				<div class="border-0 border-white/20 hover:border-white/40 transition">
					{% include "components/concert-card.njk" %}
				</div>
				{% endfor %}
			</div>
		</section>
		
</section>

<!-- Script : formatage dates + génération .ics -->
<script>
	(function(){
		function fmtLong(startISO, endISO){
			const s = new Date(startISO), e = new Date(endISO);
			const dl = s.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
			const sh = s.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
			const eh = e.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
			return dl + ' - ' + sh + '–' + eh;
		}
		document.querySelectorAll('.date-dd').forEach(el=>{
			const d=new Date(el.dataset.start);
			el.textContent = String(d.getDate()).padStart(2,'0');
		});
		document.querySelectorAll('.date-mm').forEach(el=>{
			const d=new Date(el.dataset.start);
			el.textContent = d.toLocaleDateString('fr-FR',{month:'short'}).toUpperCase();
		});
		document.querySelectorAll('.date-full').forEach(el=>{
			el.textContent = fmtLong(el.dataset.start, el.dataset.end);
		});
		
		function toICSDate(d){
			const dt = new Date(d);
			const pad = n => String(n).padStart(2,'0');
			return dt.getUTCFullYear()
			+ pad(dt.getUTCMonth()+1)
			+ pad(dt.getUTCDate()) + 'T'
			+ pad(dt.getUTCHours())
			+ pad(dt.getUTCMinutes())
			+ pad(dt.getUTCSeconds()) + 'Z';
		}
		function makeICS(obj){
			const lines = [
			'BEGIN:VCALENDAR',
			'VERSION:2.0',
			'PRODID:-//Choeur Butterfly//Concert//FR',
			'CALSCALE:GREGORIAN',
			'METHOD:PUBLISH',
			'BEGIN:VEVENT',
			'DTSTAMP:' + toICSDate(new Date().toISOString()),
			'DTSTART:' + toICSDate(obj.start),
			'DTEND:'   + toICSDate(obj.end),
			'SUMMARY:' + (obj.title || ''),
			'DESCRIPTION:' + (obj.description || ''),
			'LOCATION:' + (obj.location || ''),
			'END:VEVENT',
			'END:VCALENDAR'
			];
			return lines.join('\r\n');
		}
		document.querySelectorAll('.add-ics').forEach(btn=>{
			btn.addEventListener('click', ()=>{
				const ics = makeICS({
					title: btn.dataset.title,
					description: btn.dataset.description,
					start: btn.dataset.start,
					end: btn.dataset.end,
					location: btn.dataset.location
				});
				const blob = new Blob([ics], {type: 'text/calendar;charset=utf-8'});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'concert.ics';
				document.body.appendChild(a);
				a.click();
				URL.revokeObjectURL(url);
				a.remove();
			});
		});
	})();
</script>
